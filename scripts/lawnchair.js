var Lawnchair=function(a,b){if(!(this instanceof Lawnchair))return new Lawnchair(a,b);if(!JSON)throw"JSON unavailable! Include http://www.json.org/json2.js to fix.";if(!(arguments.length<=2&&arguments.length>0))throw"Incorrect # of ctor args!";if(b="function"==typeof arguments[0]?arguments[0]:arguments[1],a="function"==typeof arguments[0]?{}:arguments[0],"function"!=typeof b)throw"No callback was provided";this.record=a.record||"record",this.name=a.name||"records";var c;if(a.adapter){for(var d=0,e=Lawnchair.adapters.length;e>d;d++)if(Lawnchair.adapters[d].adapter===a.adapter){c=Lawnchair.adapters[d].valid()?Lawnchair.adapters[d]:void 0;break}}else for(d=0,e=Lawnchair.adapters.length;e>d&&!(c=Lawnchair.adapters[d].valid()?Lawnchair.adapters[d]:void 0);d++);if(!c)throw"No valid adapter.";for(var f in c)this[f]=c[f];for(d=0,e=Lawnchair.plugins.length;e>d;d++)Lawnchair.plugins[d].call(this);this.init(a,b)};Lawnchair.adapters=[],Lawnchair.adapter=function(a,b){b.adapter=a;var e,c="adapter valid init keys save batch get exists all remove nuke".split(" "),d=this.prototype.indexOf;for(e in b)if(-1===d(c,e))throw"Invalid adapter! Nonstandard method: "+e;Lawnchair.adapters.splice(0,0,b)},Lawnchair.plugins=[],Lawnchair.plugin=function(a){for(var b in a)"init"===b?Lawnchair.plugins.push(a[b]):this.prototype[b]=a[b]},Lawnchair.prototype={isArray:Array.isArray||function(a){return"[object Array]"===Object.prototype.toString.call(a)},indexOf:function(a,b,c,d){if(a.indexOf)return a.indexOf(b);for(c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},lambda:function(a){return this.fn(this.record,a)},fn:function(a,b){return"string"==typeof b?new Function(a,b):b},uuid:function(){var a=function(){return(0|65536*(1+Math.random())).toString(16).substring(1)};return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()},each:function(a){var b=this.lambda(a);if(this.__results){a=0;for(var c=this.__results.length;c>a;a++)b.call(this,this.__results[a],a)}else this.all(function(a){for(var c=0,d=a.length;d>c;c++)b.call(this,a[c],c)});return this}},Lawnchair.adapter("dom",function(){var a=window.localStorage,b=function(b){return{key:b+"._index_",all:function(){var b=a.getItem(this.key);return b&&(b=JSON.parse(b)),null===b&&a.setItem(this.key,JSON.stringify([])),JSON.parse(a.getItem(this.key))},add:function(b){var c=this.all();c.push(b),a.setItem(this.key,JSON.stringify(c))},del:function(b){for(var c=this.all(),d=[],e=0,f=c.length;f>e;e++)c[e]!=b&&d.push(c[e]);a.setItem(this.key,JSON.stringify(d))},find:function(a){for(var b=this.all(),c=0,d=b.length;d>c;c++)if(a===b[c])return c;return!1}}};return{valid:function(){return!!a},init:function(a,c){this.indexer=b(this.name),c&&this.fn(this.name,c).call(this,this)},save:function(b,c){var d=b.key?this.name+"."+b.key:this.name+"."+this.uuid();return this.indexer.find(d)===!1&&this.indexer.add(d),delete b.key,a.setItem(d,JSON.stringify(b)),b.key=d.slice(this.name.length+1),c&&this.lambda(c).call(this,b),this},batch:function(a,b){for(var c=[],d=0,e=a.length;e>d;d++)this.save(a[d],function(a){c.push(a)});return b&&this.lambda(b).call(this,c),this},keys:function(a){if(a){var b=this.name,c=this.indexer.all().map(function(a){return a.replace(b+".","")});this.fn("keys",a).call(this,c)}return this},get:function(b,c){if(this.isArray(b)){for(var d=[],e=0,f=b.length;f>e;e++){var g=this.name+"."+b[e];(g=a.getItem(g))&&(g=JSON.parse(g),g.key=b[e],d.push(g))}c&&this.lambda(c).call(this,d)}else g=this.name+"."+b,(g=a.getItem(g))&&(g=JSON.parse(g),g.key=b),c&&this.lambda(c).call(this,g);return this},exists:function(a,b){var c=this.indexer.find(this.name+"."+a)===!1?!1:!0;return this.lambda(b).call(this,c),this},all:function(b){for(var e,f,c=this.indexer.all(),d=[],g=0,h=c.length;h>g;g++)f=c[g],e=JSON.parse(a.getItem(f)),e.key=f.replace(this.name+".",""),d.push(e);return b&&this.fn(this.name,b).call(this,d),this},remove:function(b,c){var d=this.name+"."+(b.key?b.key:b);return this.indexer.del(d),a.removeItem(d),c&&this.lambda(c).call(this),this},nuke:function(a){return this.all(function(b){for(var c=0,d=b.length;d>c;c++)this.remove(b[c]);a&&this.lambda(a).call(this)}),this}}}()),Lawnchair.adapter("window-name",function(a,b){var c=window.top.name?JSON.parse(window.top.name):{};return{valid:function(){return"undefined"!=typeof window.top.name},init:function(d,e){c[this.name]=c[this.name]||{index:[],store:{}},a=c[this.name].index,b=c[this.name].store,this.fn(this.name,e).call(this,this)},keys:function(b){return this.fn("keys",b).call(this,a),this},save:function(d,e){var f=d.key||this.uuid();return d.key&&delete d.key,this.exists(f,function(g){g||a.push(f),b[f]=d,window.top.name=JSON.stringify(c),d.key=f,e&&this.lambda(e).call(this,d)}),this},batch:function(a,b){for(var c=[],d=0,e=a.length;e>d;d++)this.save(a[d],function(a){c.push(a)});return b&&this.lambda(b).call(this,c),this},get:function(a,c){var d;if(this.isArray(a)){d=[];for(var e=0,f=a.length;f>e;e++)d.push(b[a[e]])}else(d=b[a])&&(d.key=a);return c&&this.lambda(c).call(this,d),this},exists:function(a,c){return this.lambda(c).call(this,!!b[a]),this},all:function(c){for(var d=[],e=0,f=a.length;f>e;e++){var g=b[a[e]];g.key=a[e],d.push(g)}return this.fn(this.name,c).call(this,d),this},remove:function(d,e){for(var f=this.isArray(d)?d:[d],g=0,h=f.length;h>g;g++)delete b[f[g]],a.splice(this.indexOf(a,f[g]),1);return window.top.name=JSON.stringify(c),e&&this.lambda(e).call(this),this},nuke:function(b){return storage={},a=[],window.top.name=JSON.stringify(c),b&&this.lambda(b).call(this),this}}}()),Lawnchair.adapter("dom",function(){var a=window.localStorage,b=function(b){return{key:b+"._index_",all:function(){var b=a.getItem(JSON.stringify(this.key));return b&&(b=JSON.parse(b)),null===b&&a.setItem(JSON.stringify(this.key),JSON.stringify([])),JSON.parse(a.getItem(JSON.stringify(this.key)))},add:function(b){var c=this.all();c.push(b),a.setItem(JSON.stringify(this.key),JSON.stringify(c))},del:function(b){for(var c=this.all(),d=[],e=0,f=c.length;f>e;e++)c[e]!=b&&d.push(c[e]);a.setItem(JSON.stringify(this.key),JSON.stringify(d))},find:function(a){for(var b=this.all(),c=0,d=b.length;d>c;c++)if(a===b[c])return c;return!1}}};return{valid:function(){return!!a&&function(){var b=!0,c=Math.random();try{a.setItem(c,c)}catch(d){b=!1}return a.removeItem(c),b}()},init:function(a,c){this.indexer=b(this.name),c&&this.fn(this.name,c).call(this,this)},save:function(b,c){var d=b.key?this.name+"."+b.key:this.name+"."+this.uuid();return delete b.key,a.setItem(d,JSON.stringify(b)),this.indexer.find(d)===!1&&this.indexer.add(d),b.key=d.slice(this.name.length+1),c&&this.lambda(c).call(this,b),this},batch:function(a,b){for(var c=[],d=0,e=a.length;e>d;d++)this.save(a[d],function(a){c.push(a)});return b&&this.lambda(b).call(this,c),this},keys:function(a){if(a){var b=this.name,c=this.indexer.all(),d=[];if(Array.prototype.map)d=c.map(function(a){return a.replace(b+".","")});else for(var e in c)d.push(e.replace(b+".",""));this.fn("keys",a).call(this,d)}return this},get:function(b,c){if(this.isArray(b)){for(var d=[],e=0,f=b.length;f>e;e++){var g=this.name+"."+b[e],h=a.getItem(g);h&&(h=JSON.parse(h),h.key=b[e]),d.push(h)}c&&this.lambda(c).call(this,d)}else{var g=this.name+"."+b,h=a.getItem(g);h&&(h=JSON.parse(h),h.key=b),c&&this.lambda(c).call(this,h)}return this},exists:function(a,b){var c=this.indexer.find(this.name+"."+a)===!1?!1:!0;return this.lambda(b).call(this,c),this},all:function(b){for(var e,f,c=this.indexer.all(),d=[],g=0,h=c.length;h>g;g++)f=c[g],e=JSON.parse(a.getItem(f)),e.key=f.replace(this.name+".",""),d.push(e);return b&&this.fn(this.name,b).call(this,d),this},remove:function(b,c){var d=this;if(this.isArray(b)){var e,f=b.length,g=function(a){d.remove(b[a],function(){--f>0||c&&d.lambda(c).call(d)})};for(e=0;e<b.length;e++)g(e);return this}var h=this.name+"."+(b.key?b.key:b);return this.indexer.del(h),a.removeItem(h),c&&this.lambda(c).call(this),this},nuke:function(a){return this.all(function(b){for(var c=0,d=b.length;d>c;c++)this.remove(b[c]);a&&this.lambda(a).call(this)}),this}}}());